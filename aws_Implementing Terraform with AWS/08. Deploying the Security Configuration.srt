1
00:00:01,140 --> 00:00:04,150
[Autogenerated] alright in maine dot t f, we have two variables.

2
00:00:04,150 --> 00:00:04,810
Very simple.

3
00:00:04,810 --> 00:00:05,970
We're setting up our region,

4
00:00:05,970 --> 00:00:10,530
which is us East one and we also have a list of peering users.

5
00:00:10,530 --> 00:00:14,400
So these are the users that will be members of that peering group we're giving

6
00:00:14,400 --> 00:00:18,600
the permissions to If we open up our terra form TF bars,

7
00:00:18,600 --> 00:00:22,540
file we can see that we have a list for those peering users and

8
00:00:22,540 --> 00:00:25,830
the only user in that list is Elsie Vasquez.

9
00:00:25,830 --> 00:00:28,480
So we're all set on our variables.

10
00:00:28,480 --> 00:00:31,440
Let's go back to that main dot T f file.

11
00:00:31,440 --> 00:00:34,390
We'll scroll down to providers and now we again are

12
00:00:34,390 --> 00:00:37,740
creating two instances of the AWS provider.

13
00:00:37,740 --> 00:00:40,810
This time they're both using the same region.

14
00:00:40,810 --> 00:00:42,180
So that is the same.

15
00:00:42,180 --> 00:00:43,950
But the aliases different.

16
00:00:43,950 --> 00:00:48,510
We've got one called infra and one called SEC because I'm super creative

17
00:00:48,510 --> 00:00:52,790
and the profile that we're using for infra is the in for a profile we

18
00:00:52,790 --> 00:00:56,640
just created with the AWS Configure command.

19
00:00:56,640 --> 00:01:02,780
The profile for the SEC Alias is the SEC profile that we just created as well.

20
00:01:02,780 --> 00:01:07,110
So now we have two separate providers using two different sets of

21
00:01:07,110 --> 00:01:11,640
credentials that reference to different AWS accounts,

22
00:01:11,640 --> 00:01:13,910
man, that's all set up that's ready to do.

23
00:01:13,910 --> 00:01:15,190
And that's awesome.

24
00:01:15,190 --> 00:01:16,840
Let's scroll down a little bit.

25
00:01:16,840 --> 00:01:22,340
In our data sources, we are using a data source called A W s collar identity,

26
00:01:22,340 --> 00:01:25,160
and this basically retrieves information about the

27
00:01:25,160 --> 00:01:27,890
identity that's being used for a provider.

28
00:01:27,890 --> 00:01:32,790
One of the things you can get is the account IDE for that identity,

29
00:01:32,790 --> 00:01:34,370
and we're going to need that account.

30
00:01:34,370 --> 00:01:34,860
IDE,

31
00:01:34,860 --> 00:01:39,020
when we're configuring the policies and rolls within

32
00:01:39,020 --> 00:01:42,790
the context of each data source, I have a provider set here.

33
00:01:42,790 --> 00:01:47,000
So I'm getting the color identity information for the infra

34
00:01:47,000 --> 00:01:52,240
profile and the color identity information for the SEC profile

35
00:01:52,240 --> 00:01:53,650
scrolling down a little bit more.

36
00:01:53,650 --> 00:01:57,060
We are going to get into our resource creation first

37
00:01:57,060 --> 00:02:00,340
by creating a I am role policy.

38
00:02:00,340 --> 00:02:04,680
This is that peering policy that we're going to assign to the peering role.

39
00:02:04,680 --> 00:02:07,380
So we're giving it the name VPC peering policy.

40
00:02:07,380 --> 00:02:08,720
Very creative, I know.

41
00:02:08,720 --> 00:02:11,440
And then for the role we're referencing a role that we're going to

42
00:02:11,440 --> 00:02:14,440
create a little further down in the configuration.

43
00:02:14,440 --> 00:02:17,050
The provider is a w s dot ___.

44
00:02:17,050 --> 00:02:22,640
So we know we're creating this policy within the security account.

45
00:02:22,640 --> 00:02:24,540
If we look at the policy verb ege,

46
00:02:24,540 --> 00:02:26,830
the important thing to note here is that we have to

47
00:02:26,830 --> 00:02:28,820
actions that are being allowed.

48
00:02:28,820 --> 00:02:31,740
One is except VPC peering connection.

49
00:02:31,740 --> 00:02:33,560
So if there's a pending connection,

50
00:02:33,560 --> 00:02:37,790
we can accept it and also describe the PC peering connection.

51
00:02:37,790 --> 00:02:41,310
Because if we can't describe the connections, we can't accept them.

52
00:02:41,310 --> 00:02:44,140
So you kind of need both actions in there.

53
00:02:44,140 --> 00:02:46,380
That's everything that goes into the peering policy.

54
00:02:46,380 --> 00:02:48,440
Just those two actions.

55
00:02:48,440 --> 00:02:51,640
Now we need to assign that peering policy to a role.

56
00:02:51,640 --> 00:02:55,380
Let's scroll down a little bit more and we get into the configuration of that.

57
00:02:55,380 --> 00:02:56,840
I am role.

58
00:02:56,840 --> 00:02:59,750
We're going to call that the pier role once again.

59
00:02:59,750 --> 00:03:03,740
The provider is a W s dot sec because we're creating this role in the

60
00:03:03,740 --> 00:03:07,590
security account within the body of the I am role.

61
00:03:07,590 --> 00:03:10,060
We're creating an assume role policy.

62
00:03:10,060 --> 00:03:16,520
And this basically says that another AWS account can assume this role.

63
00:03:16,520 --> 00:03:20,810
So the action is STS assume role and the principle that can

64
00:03:20,810 --> 00:03:24,340
assume this role is that other A W s account.

65
00:03:24,340 --> 00:03:29,070
And that's why we needed the A W s color identity for the infra profile.

66
00:03:29,070 --> 00:03:34,240
Because we needed the account IDE to fill out that principle line.

67
00:03:34,240 --> 00:03:38,140
Now that we have that all set up we can go over to the infra

68
00:03:38,140 --> 00:03:40,990
account and create the things we need there,

69
00:03:40,990 --> 00:03:44,930
so we'll scroll down a little bit and now we're creating that I am group.

70
00:03:44,930 --> 00:03:48,600
In the infra account, the name will be vpc peering,

71
00:03:48,600 --> 00:03:50,740
so it's pretty obvious what it's for.

72
00:03:50,740 --> 00:03:53,730
And the provider we're referencing is a W s dot infra.

73
00:03:53,730 --> 00:03:56,940
So we know this is using the infrastructure account.

74
00:03:56,940 --> 00:03:59,200
Then we want to add some members to that group.

75
00:03:59,200 --> 00:04:01,480
And remember, we only have one member defined.

76
00:04:01,480 --> 00:04:03,540
And that's Elsie Vasquez.

77
00:04:03,540 --> 00:04:07,310
So we're creating a resource called I Am group membership and the whole

78
00:04:07,310 --> 00:04:10,040
point of this resources just to add members to a group,

79
00:04:10,040 --> 00:04:13,040
we have to tell it, What's the name of this resources?

80
00:04:13,040 --> 00:04:15,500
The provider, which is a w s dot infra,

81
00:04:15,500 --> 00:04:18,340
because we're still working with the infra account,

82
00:04:18,340 --> 00:04:21,370
the users we want to AD DS members and we're going to hand it

83
00:04:21,370 --> 00:04:23,930
the variable that has our list of users.

84
00:04:23,930 --> 00:04:25,910
And then finally what group are we adding?

85
00:04:25,910 --> 00:04:27,110
Those users to?

86
00:04:27,110 --> 00:04:31,180
So now we've got Elsie Vasquez assigned to this group Now we

87
00:04:31,180 --> 00:04:34,650
have to give this group a policy that allows it to assume the

88
00:04:34,650 --> 00:04:36,940
peering role in the security account.

89
00:04:36,940 --> 00:04:40,740
Let's scroll down a little bit and we do that by creating a resources.

90
00:04:40,740 --> 00:04:42,770
I am group policy.

91
00:04:42,770 --> 00:04:45,040
We're gonna call it peering policy.

92
00:04:45,040 --> 00:04:48,130
We're assigning to the group we just created and

93
00:04:48,130 --> 00:04:50,500
we're using the provider A W s infra.

94
00:04:50,500 --> 00:04:54,540
So we know this is all happening in the infra account.

95
00:04:54,540 --> 00:05:00,540
The policy is a very simple STS assume action and the resources going to

96
00:05:00,540 --> 00:05:04,880
be the role that we created in the security account.

97
00:05:04,880 --> 00:05:08,560
So we're just referencing the ARN for that role that

98
00:05:08,560 --> 00:05:10,300
we created in the security account.

99
00:05:10,300 --> 00:05:15,640
So if you have this policy, you can assume that role in the other account.

100
00:05:15,640 --> 00:05:19,130
Now, with that, we have all that set up down in the outputs were out.

101
00:05:19,130 --> 00:05:22,460
Putting that peer role aren't because we're going to need

102
00:05:22,460 --> 00:05:25,660
that when we create that peering connection.

103
00:05:25,660 --> 00:05:27,880
So that's everything in the configuration.

104
00:05:27,880 --> 00:05:30,830
Let's go ahead over to the commands and we're going to

105
00:05:30,830 --> 00:05:33,440
run the terra form initialization.

106
00:05:33,440 --> 00:05:36,940
So I go ahead and open up my command window,

107
00:05:36,940 --> 00:05:44,140
go into the proper folder and run Terra form in it.

108
00:05:44,140 --> 00:05:46,140
There we do terra form in it.

109
00:05:46,140 --> 00:05:51,940
And, as usual, that's going to download our plug ins and the provider.

110
00:05:51,940 --> 00:05:53,540
All right, that's all set.

111
00:05:53,540 --> 00:05:58,610
So now let's run terra form plan dash out roles dot t f plan and that

112
00:05:58,610 --> 00:06:03,450
will create that execution plan that we need now.

113
00:06:03,450 --> 00:06:04,490
I always run,

114
00:06:04,490 --> 00:06:08,760
dash out and create a T F plan instead of going directly to the apply.

115
00:06:08,760 --> 00:06:10,980
And that's just generally a best practice.

116
00:06:10,980 --> 00:06:14,270
And I'd recommend doing that regardless of what environment you're using.

117
00:06:14,270 --> 00:06:15,440
Terra form in the.

118
00:06:15,440 --> 00:06:18,710
All right, so that successfully generated a good plan.

119
00:06:18,710 --> 00:06:22,830
Let's go ahead and run terra form apply to create all those

120
00:06:22,830 --> 00:06:27,840
configurations across the two accounts.

121
00:06:27,840 --> 00:06:29,810
And clearly that ran very quickly.

122
00:06:29,810 --> 00:06:32,930
The reason being we're just creating settings in I am We're

123
00:06:32,930 --> 00:06:37,430
not actually spinning up new resources, so it usually goes by pretty fast.

124
00:06:37,430 --> 00:06:39,870
Now we want to make a note of this arm for later.

125
00:06:39,870 --> 00:06:44,740
So I'm gonna head and copy this,

126
00:06:44,740 --> 00:06:48,300
and I'm just gonna pace that over in a Notepad I have on another screen.

127
00:06:48,300 --> 00:06:50,300
So that I can reference it later.

128
00:06:50,300 --> 00:06:52,820
Okay, so we have our roles set up.

129
00:06:52,820 --> 00:06:54,270
We have our policy set up.

130
00:06:54,270 --> 00:06:55,400
We are all set to go.

131
00:06:55,400 --> 00:06:56,500
What's the next thing we need?

132
00:06:56,500 --> 00:06:57,210
A.

133
00:06:57,210 --> 00:07:02,000
We need that security. VPC Let's look at the slide again for a moment.

