1
00:00:01,140 --> 00:00:01,510
[Autogenerated] all right,

2
00:00:01,510 --> 00:00:06,360
we have successfully created the groups and rolls to allow for appearing.

3
00:00:06,360 --> 00:00:10,340
We've successfully created our security vpc that Joshua

4
00:00:10,340 --> 00:00:12,410
can do use for all of his security tools.

5
00:00:12,410 --> 00:00:16,960
Now it's time to get this bad boy peered up with our Dev Vpc

6
00:00:16,960 --> 00:00:19,550
So let's go ahead and go back to one dash,

7
00:00:19,550 --> 00:00:26,340
Dev Dash vpc And within there you'll see there's a peering TF dot rename file.

8
00:00:26,340 --> 00:00:30,560
Let's go ahead and open up our commands dot txt file and I'm gonna hide the

9
00:00:30,560 --> 00:00:33,640
terminal for a second just to give us a little more room.

10
00:00:33,640 --> 00:00:34,940
All right,

11
00:00:34,940 --> 00:00:38,570
in the commands dot txt I have a section here called

12
00:00:38,570 --> 00:00:40,790
multiple provider module commands.

13
00:00:40,790 --> 00:00:43,320
So you know where we're coming from and the first thing we're gonna do is

14
00:00:43,320 --> 00:00:48,240
rename that peering dot t f dot rename to just peering dot t f.

15
00:00:48,240 --> 00:00:49,680
And by doing that, rename,

16
00:00:49,680 --> 00:00:54,640
what's in that file will now be part of this ______ form configuration.

17
00:00:54,640 --> 00:00:59,540
So let's go ahead and run that to rename the file,

18
00:00:59,540 --> 00:01:05,570
we'll go up a directory and go into our Dev VPC Directory Run that rename.

19
00:01:05,570 --> 00:01:08,590
Now that file is renamed, and since it's renamed,

20
00:01:08,590 --> 00:01:11,540
let's go Ahead and take a look at what's in that file.

21
00:01:11,540 --> 00:01:15,320
Okay, Hide the terminal to give ourselves some room.

22
00:01:15,320 --> 00:01:17,030
And we've got two variables in here.

23
00:01:17,030 --> 00:01:18,270
We have the destination.

24
00:01:18,270 --> 00:01:19,450
Vpc IDE.

25
00:01:19,450 --> 00:01:22,150
That would be the vpc idea of the security.

26
00:01:22,150 --> 00:01:25,290
Vpc and we have the pier role ARN,

27
00:01:25,290 --> 00:01:29,200
which we had as output from when we created the roles and policies.

28
00:01:29,200 --> 00:01:30,070
Alright, awesome.

29
00:01:30,070 --> 00:01:34,740
We already have the values for those variables scrolling down to the provider.

30
00:01:34,740 --> 00:01:35,810
This is a little bit different.

31
00:01:35,810 --> 00:01:37,920
You might notice a different section in here.

32
00:01:37,920 --> 00:01:42,060
We're giving it the alias Pierre to distinguish it from the other provider.

33
00:01:42,060 --> 00:01:47,780
That's part of this dead VPC configuration for the profile we're using infra.

34
00:01:47,780 --> 00:01:50,160
So we're using the infrastructure account and we

35
00:01:50,160 --> 00:01:53,120
specified and assume role setting.

36
00:01:53,120 --> 00:01:56,650
And this says we want to assume a role that's in a

37
00:01:56,650 --> 00:01:59,650
different account for this provider.

38
00:01:59,650 --> 00:02:02,200
And that's why we need that peer role,

39
00:02:02,200 --> 00:02:06,080
aren't This is where we assume that peering role in the security

40
00:02:06,080 --> 00:02:09,120
accounts So we can except the peering connection.

41
00:02:09,120 --> 00:02:10,140
Tricky.

42
00:02:10,140 --> 00:02:11,440
Pretty cool, though.

43
00:02:11,440 --> 00:02:13,040
All right, down in data sources,

44
00:02:13,040 --> 00:02:18,500
we're going to need the caller identity for that AWS pure provider

45
00:02:18,500 --> 00:02:22,640
because we're gonna need that account IDE again scrolling down some

46
00:02:22,640 --> 00:02:27,710
more We get into creating the peering connection we need the VPC IDE

47
00:02:27,710 --> 00:02:32,010
off the source vpc That would be our Deb vpc It's reaching out to make

48
00:02:32,010 --> 00:02:33,840
that peering connection.

49
00:02:33,840 --> 00:02:37,960
We need the vpc IDE of the VPC it wants to peer with.

50
00:02:37,960 --> 00:02:41,000
That would be the security VPC which we have stored in

51
00:02:41,000 --> 00:02:44,240
our variable destination vpc IDE.

52
00:02:44,240 --> 00:02:49,670
We need the owner ID of that peering vpc which would be

53
00:02:49,670 --> 00:02:52,690
the account IDE of the security account.

54
00:02:52,690 --> 00:02:57,540
And we got that from the AWS Caller identity data source.

55
00:02:57,540 --> 00:03:01,760
We need the region where that peering vpc lives which we have

56
00:03:01,760 --> 00:03:04,840
stored in var region and finally auto except says,

57
00:03:04,840 --> 00:03:07,690
don't try to automatically accept this connection

58
00:03:07,690 --> 00:03:09,290
because it's in a different account.

59
00:03:09,290 --> 00:03:11,540
We're going to do that in a separate step.

60
00:03:11,540 --> 00:03:13,720
That separate step is directly below.

61
00:03:13,720 --> 00:03:17,410
We're creating a resource AWS vpc peering connection.

62
00:03:17,410 --> 00:03:21,020
Except er it's a very special type of resource and it does

63
00:03:21,020 --> 00:03:24,210
exactly what it says on the label for the provider.

64
00:03:24,210 --> 00:03:29,040
We're using a W s peer and you'll notice for the peering connection.

65
00:03:29,040 --> 00:03:30,710
We didn't specify a provider.

66
00:03:30,710 --> 00:03:36,050
We're using the default provider for the Dev VPC that's in the infrastructure

67
00:03:36,050 --> 00:03:41,240
account so that peering connection above uses the infrastructure account this

68
00:03:41,240 --> 00:03:46,560
connection except they're below is using the assumed role in the security

69
00:03:46,560 --> 00:03:49,940
account by referencing a w s dot pierre.

70
00:03:49,940 --> 00:03:52,540
And then we have to specify the peering connection we're going to

71
00:03:52,540 --> 00:03:56,570
try to accept which we can get as a property of the peering

72
00:03:56,570 --> 00:03:58,490
connection resources we created above.

73
00:03:58,490 --> 00:04:00,350
And we'll set auto except the true,

74
00:04:00,350 --> 00:04:05,540
because now we're ready to accept that connection using the assumed role.

75
00:04:05,540 --> 00:04:08,000
So that's everything that's in this configuration.

76
00:04:08,000 --> 00:04:11,820
Let's go ahead and go back to the commands and we'll note

77
00:04:11,820 --> 00:04:14,450
that we want to run terra form plan.

78
00:04:14,450 --> 00:04:19,140
We've already initialized this configuration from when we created the Dev VPC.

79
00:04:19,140 --> 00:04:21,020
But now we need that peering role.

80
00:04:21,020 --> 00:04:24,260
ARN and the destination vpc IDE.

81
00:04:24,260 --> 00:04:27,830
So I'm going ahead and grab that peering role ARN from

82
00:04:27,830 --> 00:04:30,590
my Notepad and paste it in here.

83
00:04:30,590 --> 00:04:31,740
Okay, there we go.

84
00:04:31,740 --> 00:04:36,490
We'll scroll over and now I'm gonna grab that vpc IDE of

85
00:04:36,490 --> 00:04:40,440
the security vpc and paste it in here.

86
00:04:40,440 --> 00:04:41,140
Great!

87
00:04:41,140 --> 00:04:45,040
And now I'm going to copy this entire command,

88
00:04:45,040 --> 00:04:49,100
Bring the terminal back up and we'll go ahead and paste it

89
00:04:49,100 --> 00:04:53,740
in here and it's going to run an execution plan that

90
00:04:53,740 --> 00:05:00,740
includes this peering connection.

91
00:05:00,740 --> 00:05:03,580
All right, so it's creating two new resources,

92
00:05:03,580 --> 00:05:06,440
just like we asked it to ones that peering connection.

93
00:05:06,440 --> 00:05:10,800
And the second one is that, except er of the peering connection looks good to me.

94
00:05:10,800 --> 00:05:22,160
Let's go ahead and run terra form, apply and paste it in here and there we go.

95
00:05:22,160 --> 00:05:25,380
It has successfully created that peering connection.

96
00:05:25,380 --> 00:05:30,340
Let's go head over to the AWS console and just confirm visually.

97
00:05:30,340 --> 00:05:32,960
All right, we're in the AWS console.

98
00:05:32,960 --> 00:05:36,140
We can See, we've got our Dev vpc here.

99
00:05:36,140 --> 00:05:40,240
Let's go ahead and go down to peering connections.

100
00:05:40,240 --> 00:05:44,060
Here is our peering connection we can see the the requester VPC

101
00:05:44,060 --> 00:05:47,380
which is our Dev vpc and the except er VPC,

102
00:05:47,380 --> 00:05:52,240
which is our security vpc in the other account Scroll Scooch this up a

103
00:05:52,240 --> 00:05:55,650
little bit and take a look at the requester owner.

104
00:05:55,650 --> 00:06:00,520
That's the account IDE for our infrastructure account and the except er

105
00:06:00,520 --> 00:06:05,130
VPC owner is the account IDE for the security account on we can see the

106
00:06:05,130 --> 00:06:09,540
at the except er vpc cider is 172.16.

107
00:06:09,540 --> 00:06:16,000
So we definitely got everything set up correctly. JSON Gibson is going to be super happy

