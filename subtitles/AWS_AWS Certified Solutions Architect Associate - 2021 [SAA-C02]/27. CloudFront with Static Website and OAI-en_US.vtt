WEBVTT
1
00:00:02.410 --> 00:00:07.370
In this lab we're going to set up an S3 bucket and configure it as a static Web site.

2
00:00:07.450 --> 00:00:13.750
And then we're going to enable a CloudFront distribution so that we can access the content in the static

3
00:00:13.750 --> 00:00:15.270
Web site.

4
00:00:15.550 --> 00:00:21.890
One of the other things we want to do is and this is a situation that you might find quite regularly.

5
00:00:22.090 --> 00:00:28.720
You want your users to be able to access your content free CloudFront but then you might not necessarily

6
00:00:28.720 --> 00:00:32.470
want them to be able to also access it through the S3 bucket.

7
00:00:32.470 --> 00:00:38.340
Now typically when you configure an S3 bucket as a static web site you'll enable public access.

8
00:00:38.410 --> 00:00:44.290
So that means you could theoretically have users connect saying it straight to your free bucket.

9
00:00:44.290 --> 00:00:49.570
So what we're going to do instead is we're going to set up a bucket policy that only allows the cloud

10
00:00:49.570 --> 00:00:56.110
front distribution to connect to the static web site and there's some authentication using what's called

11
00:00:56.110 --> 00:01:01.770
an origin access identity which is a type of user which you can create on CloudFront.

12
00:01:01.870 --> 00:01:08.450
So that secures our content to make sure that it only comes free CloudFront now sometimes creating

13
00:01:08.460 --> 00:01:11.190
CloudFront distributions can take quite some time.

14
00:01:11.190 --> 00:01:15.980
It can be anything from sort of 10 or 15 minutes to even longer than an hour.

15
00:01:15.990 --> 00:01:19.410
So what I've done is I've actually set up this beforehand.

16
00:01:19.410 --> 00:01:23.730
However I don't want it to look like I'm cheating so I'm going to actually go through and show you step

17
00:01:23.730 --> 00:01:26.650
by step how we can do this right from the very beginning.

18
00:01:26.910 --> 00:01:31.500
But we already have a configuration up running as well which we'll go over and I'll walk you through

19
00:01:31.500 --> 00:01:34.910
all the settings that I've configured so let's head over to the console

20
00:01:38.290 --> 00:01:46.490
and the first thing we need to do is head over to S3 you'll remember that we actually created a

21
00:01:46.510 --> 00:01:51.940
dctlab.com domain name and a hosted zone in route 53.

22
00:01:51.950 --> 00:01:59.240
Now what I want to do for this lab is I want to be able to access my CloudFront distribution using my

23
00:01:59.240 --> 00:02:00.730
own domain name.

24
00:02:00.800 --> 00:02:06.260
And so there's a couple of things I need to do firstly for the static web site you need to have your

25
00:02:06.470 --> 00:02:11.390
bucket the same name as your actual domain name.

26
00:02:11.390 --> 00:02:19.800
So if your your domain name is example.co.uk then your bucket needs to be example.co.uk.

27
00:02:19.990 --> 00:02:21.660
I've got dctlabs.com.

28
00:02:21.700 --> 00:02:28.910
So what I've done is I've created my bucket and then I've uploaded the index.html file and error

29
00:02:29.050 --> 00:02:30.170
.html.

30
00:02:30.220 --> 00:02:34.960
Now these will be in the course downloads but really for the index.html you can just create a

31
00:02:34.960 --> 00:02:41.800
text file add some text in it like "this is my S3 static web site" and then just save it as .html

32
00:02:42.100 --> 00:02:44.380
and just upload that and that will be fine.

33
00:02:44.380 --> 00:02:48.240
I think my error.html probably just says error or something silly like that.

34
00:02:48.520 --> 00:02:49.600
Very very basic.

35
00:02:49.600 --> 00:02:54.670
You don't need anything to be in there really but you do need these documents for your static Web site.

36
00:02:54.700 --> 00:03:02.020
I've then got a couple of images and this is just so that we can show the caching functionality of cloud

37
00:03:02.020 --> 00:03:02.870
front.

38
00:03:02.890 --> 00:03:08.680
The other thing you'll notice here is I have a folder and what I've got in here is some log files and

39
00:03:08.680 --> 00:03:13.130
we'll go over these later and I'll show you how you set up the logging as well.

40
00:03:14.730 --> 00:03:21.750
So in terms of the way this bucket is set up we need to switch off this block all public access and

41
00:03:21.750 --> 00:03:27.590
we've actually got a bucket policy here and this will be generated by CloudFront.

42
00:03:28.050 --> 00:03:33.870
And then under properties I've enabled static web site hosting.

43
00:03:34.070 --> 00:03:39.530
So let's go back and let's just create a bucket so I can show you step by step and let's just say we

44
00:03:39.530 --> 00:03:45.780
call this Neal CloudFront 2019.

45
00:03:45.790 --> 00:03:47.230
Hopefully that's going to be available

46
00:03:50.400 --> 00:03:51.180
and it is.

47
00:03:51.210 --> 00:03:53.190
So you would then go in.

48
00:03:53.190 --> 00:04:01.880
You can go to permissions to block public access and click on Save and you'll have to hit confirm

49
00:04:01.880 --> 00:04:12.290
in their use then to get this working you'll need to then go into public access and just enable list

50
00:04:12.290 --> 00:04:18.410
objects and we can then go back and upload our files.

51
00:04:18.410 --> 00:04:25.610
So what I want is to just upload the error and the index file should apply for those together let's just

52
00:04:25.610 --> 00:04:27.500
do that again.

53
00:04:27.620 --> 00:04:37.230
So I need to get the index upload that file and then at a minimum I need to just go in and enable public

54
00:04:37.230 --> 00:04:39.490
access on this so we can remove this later.

55
00:04:39.510 --> 00:04:42.370
But this is just to get it working initially so we can see that it works.

56
00:04:43.330 --> 00:04:52.740
So the next thing I can then go in and do is enable static website hosting and we just choose use this

57
00:04:52.740 --> 00:05:01.860
bucket to host a Web site and then we put an index.html and error.html and click on Save and

58
00:05:01.860 --> 00:05:09.010
then we can grab this U.R.L. and let's just see if we can access our bucket.

59
00:05:09.010 --> 00:05:11.700
So sure enough that's my index.html file.

60
00:05:11.700 --> 00:05:13.330
So that was enough to set it up.

61
00:05:13.350 --> 00:05:16.620
Now remember all I used here was the name of the bucket.

62
00:05:16.620 --> 00:05:21.390
If you want to be had to use a custom domain name you'd also need to put your .com or whatever suffix

63
00:05:21.390 --> 00:05:22.460
on the end as well.

64
00:05:22.650 --> 00:05:25.050
So that's how to set up your bucket.

65
00:05:25.080 --> 00:05:33.610
Now let's go over to CloudFront and you can find CloudFront under networking and content delivery so you

66
00:05:33.610 --> 00:05:38.350
can see here that I already have a distribution and let's just go back to the diagrams from earlier.

67
00:05:38.350 --> 00:05:44.900
You'll remember that a distribution is the way you set up and configure CloudFront and you have web

68
00:05:44.900 --> 00:05:49.020
and RTMP distributions and then your origins are your buckets.

69
00:05:49.030 --> 00:05:54.970
So in our case we've got a static web site bucket which is where our images are going to be served from

70
00:05:55.650 --> 00:06:01.730
and a distribution is how we connect and configure the connection between CloudFront and the origin.

71
00:06:01.870 --> 00:06:05.050
So if we head back here we will create a new one.

72
00:06:05.050 --> 00:06:07.340
I just want to in fact now we'll do that first.

73
00:06:07.360 --> 00:06:12.340
Let's create a new distribution just so you can see the settings so this is where you choose between

74
00:06:12.670 --> 00:06:15.270
Web or RTMP.

75
00:06:15.700 --> 00:06:18.440
And here you can put in your your domain name.

76
00:06:18.440 --> 00:06:21.850
So for instance I can choose that new bucket that we just created.

77
00:06:21.880 --> 00:06:26.370
Neal CloudFront test then you can choose a path within that bucket.

78
00:06:26.380 --> 00:06:30.760
For instance if you had a directory you might have you know your images slash in there but we don't

79
00:06:30.760 --> 00:06:35.620
need that for now and you can then choose restrict bucket access.

80
00:06:35.750 --> 00:06:40.210
And this is important so this is what we've done on our existing distribution.

81
00:06:40.210 --> 00:06:42.290
I'll show you the setting shortly.

82
00:06:42.290 --> 00:06:49.250
Restricting bucket access means that you force users to connect to a CloudFront and stop them from

83
00:06:49.250 --> 00:06:59.610
being able to connect to your S3 bucket directly and you can use an existing access or identity or create

84
00:06:59.610 --> 00:07:00.120
a new one.

85
00:07:00.120 --> 00:07:06.660
So again the origin access identity is essentially a user that's created within CloudFront and you

86
00:07:06.720 --> 00:07:08.910
then restrict access to that identity.

87
00:07:08.940 --> 00:07:12.000
So CloudFront let's just go back to the diagram.

88
00:07:12.000 --> 00:07:18.090
So CloudFront has a user and this and it has its own sort of credentials.

89
00:07:18.510 --> 00:07:24.530
And that user is allowed in the bucket policy to then access the website.

90
00:07:24.540 --> 00:07:26.710
So you can't come from any other way.

91
00:07:26.730 --> 00:07:30.960
It's very important and I'm going over this a few times just because this does pop up on the exam quite

92
00:07:30.960 --> 00:07:31.290
a lot.

93
00:07:32.760 --> 00:07:36.010
And what we can do here is click Grant S3 permissions on bucket.

94
00:07:36.060 --> 00:07:39.690
Yes and the bucket policy will be updated for us.

95
00:07:39.690 --> 00:07:44.830
Now remember we didn't actually have a bucket policy so it's just going to create one for us.

96
00:07:44.910 --> 00:07:52.350
You can then choose custom headers you can choose whether to allow HTTP and HTTPS whether to redirect

97
00:07:52.370 --> 00:07:59.730
to HTTPS, or just use HTTPS only, and just you know reject any HTTP requests you can select the methods

98
00:07:59.730 --> 00:08:01.020
that are allowed.

99
00:08:01.350 --> 00:08:04.470
We'll talk about field level encryption a bit later that's another option.

100
00:08:06.170 --> 00:08:10.450
And you can then specify different values for object caching.

101
00:08:10.460 --> 00:08:19.350
So this is your time to live minimum, maximum and default and you can then choose to forward cookies

102
00:08:19.350 --> 00:08:29.290
or whitelist the certain cookies that you want to allow you can configure query string forwarding and

103
00:08:29.290 --> 00:08:36.250
caching again choosing a white list if you like or one of these settings you can then choose to restrict

104
00:08:36.250 --> 00:08:37.660
Viewer Access.

105
00:08:37.660 --> 00:08:43.330
And if you do this you're actually restricting users to using CloudFront signed

106
00:08:43.400 --> 00:08:48.790
URLs so now not only are you stopping users from connecting directly to your origin but you can

107
00:08:48.790 --> 00:08:54.400
now ensure that they can only access your content using signed URLs or signed cookies.

108
00:08:54.400 --> 00:09:01.580
So we just disable that for now and we'll talk about Lambda function associations later this is about

109
00:09:01.580 --> 00:09:07.400
Lambda Edge and then you can choose your price class and what this does is it controls where your content

110
00:09:07.430 --> 00:09:09.020
is distributed to.

111
00:09:09.080 --> 00:09:12.560
So let's go back to this diagram.

112
00:09:12.560 --> 00:09:17.750
So you remember that we've got the regional edge caches and the edge locations and these are all over

113
00:09:17.750 --> 00:09:18.160
the world.

114
00:09:18.170 --> 00:09:19.450
There's hundreds of them.

115
00:09:19.460 --> 00:09:21.200
I think I've got this diagram open as well.

116
00:09:21.230 --> 00:09:23.780
So these are where they are now.

117
00:09:23.780 --> 00:09:27.980
Key thing to point out is these are not related to the AWS regions.

118
00:09:28.070 --> 00:09:31.670
They might be in an AWS region but they're not related.

119
00:09:31.670 --> 00:09:38.940
So they could be completely separate locations they might not be near or in an AWS datacenter at all.

120
00:09:38.960 --> 00:09:44.510
So they are not part of your region or your availability zone.

121
00:09:44.510 --> 00:09:46.960
They're just within a certain geographical area.

122
00:09:46.970 --> 00:09:50.060
So what you can do here is you can limit that geographical area.

123
00:09:50.060 --> 00:09:55.700
You can say all or you know best performance obviously means it's gonna be the best performance if you

124
00:09:55.700 --> 00:10:00.680
have a global user base but if your user base is in U.S. Canada and Europe then you probably want to select

125
00:10:00.680 --> 00:10:01.640
that instead.

126
00:10:01.930 --> 00:10:04.010
I'll just leave it on the default.

127
00:10:04.010 --> 00:10:10.250
You could connect to web application firewall web ACL and you can choose alternate domain names and

128
00:10:10.250 --> 00:10:12.860
we've done this on our other distribution.

129
00:10:13.250 --> 00:10:19.730
So you know I would put in dctlabs.com and then I could choose this certificate and I can choose

130
00:10:19.730 --> 00:10:20.900
my certificate.

131
00:10:21.140 --> 00:10:25.160
I'm just gonna leave this as default and you get a CloudFront certificate.

132
00:10:25.160 --> 00:10:28.380
And here we can choose our default route objects.

133
00:10:28.420 --> 00:10:31.440
So in our case we've got indexed or hasty email.

134
00:10:32.030 --> 00:10:33.790
And then you can choose to enable logging.

135
00:10:33.830 --> 00:10:37.310
I'll leave this off but I'll show you the logs I enabled on my upper distribution.

136
00:10:37.340 --> 00:10:43.430
So I show you the logs and we then just click Create distribution and it's just warning me that I can't

137
00:10:43.430 --> 00:10:48.330
have I can't put in this domain name without verifying that I own it.

138
00:10:48.350 --> 00:10:54.150
Now if I'd selected the certificate which I have verified I have verified ownership of DCT labs dot

139
00:10:54.150 --> 00:10:55.850
com when I created the certificate.

140
00:10:55.870 --> 00:11:01.760
So it would actually allow me but we're not doing that now anyway so I'll just put that back to default

141
00:11:02.180 --> 00:11:04.310
and click on Create distribution.

142
00:11:04.310 --> 00:11:09.080
So we're back on distributions now and you can see that this one is in progress and that can take quite

143
00:11:09.080 --> 00:11:09.650
a while.

144
00:11:09.740 --> 00:11:16.340
Bearing in mind this is going to cache your content and distribute it quite widely so have a think about

145
00:11:16.460 --> 00:11:17.910
how many of these you actually create.

146
00:11:17.960 --> 00:11:20.930
I would be a little bit cautious about how much data you upload.

147
00:11:20.930 --> 00:11:27.830
Have a look into the pricing you do get charged for data out from your CloudFront distribution so the

148
00:11:27.830 --> 00:11:35.120
data that users pull and then you do get charged for data transfer between CloudFront and your origin

149
00:11:35.300 --> 00:11:38.870
and then there's also charges for the amount of requests.

150
00:11:38.870 --> 00:11:39.600
So have a look.

151
00:11:39.620 --> 00:11:44.630
I think if you just keep it the labs fairly sure and delete your distributions afterwards you should

152
00:11:44.630 --> 00:11:48.310
be able to not pay any money and just get it within the freezer.

153
00:11:48.320 --> 00:11:52.500
So let's have a look now at our distribution here.

154
00:11:52.500 --> 00:11:59.160
So if I go into distribution settings and this is the one I created earlier and you can see I've enabled

155
00:11:59.160 --> 00:12:04.990
a log prefix so I created a prefix which means that my logs are going to go into a folder within my

156
00:12:04.990 --> 00:12:06.020
bucket.

157
00:12:06.430 --> 00:12:13.360
We've configured this alternate domain name and you can also see that I've configured my certificate

158
00:12:13.360 --> 00:12:14.530
here as well.

159
00:12:14.530 --> 00:12:21.370
We can go in and click at it and we can see that configuration I choose I chose the SSL certificate

160
00:12:22.420 --> 00:12:28.210
I've got my default route document I've chosen my bucket for the logs which is the same log the same

161
00:12:28.210 --> 00:12:33.280
bucket as my static web site is running it but I've got a prefix so that the logs go in to see if logs

162
00:12:36.000 --> 00:12:38.070
and that sort of enabled distribution.

163
00:12:38.070 --> 00:12:40.300
So that's all looking good.

164
00:12:40.440 --> 00:12:46.500
If we then go to origins and origin groups you can see here that you can have multiple origins.

165
00:12:46.500 --> 00:12:52.170
So let's just go back to this diagram and you can see hey I've got a distribution and I'll have multiple

166
00:12:52.170 --> 00:12:53.660
origins coming off it.

167
00:12:53.850 --> 00:12:57.390
And then with this other one I've just got one origin coming off of it.

168
00:12:58.200 --> 00:13:05.190
So the way this works is you can credit after origin so let's just let's just choose one of these other

169
00:13:06.470 --> 00:13:10.850
buckets that I've got and I'm just going to click Create.

170
00:13:11.240 --> 00:13:16.220
So I've got this DCT images bucket and I've now got two origins.

171
00:13:16.550 --> 00:13:23.420
So what I could do is for instance if I wanted to make sure that certain traffic went to this origin

172
00:13:23.720 --> 00:13:30.010
rather than this one then I use the behaviors and I credit behaviour and he can say I was playing around

173
00:13:30.080 --> 00:13:30.800
I did this earlier.

174
00:13:30.800 --> 00:13:34.610
So I've already got this behaviour let's just delete that out and we'll create it again.

175
00:13:34.610 --> 00:13:37.200
Not that there's anything really complex to it anyway.

176
00:13:37.210 --> 00:13:39.580
You let just come in and you say what's the path pattern.

177
00:13:39.590 --> 00:13:42.130
So I could say images slash star.

178
00:13:42.140 --> 00:13:50.450
So what happens now is that anything that's got this in the URL is going to be redirected to the origin

179
00:13:50.450 --> 00:13:51.590
that we specify.

180
00:13:51.620 --> 00:13:53.030
So you can choose your origins here.

181
00:13:53.030 --> 00:14:00.110
So I want this images requests to go to my images bucket and what you can do also with the behaviors

182
00:14:00.110 --> 00:14:04.700
you can change lots of these settings so you can go through and you can change the T ls in the object

183
00:14:04.700 --> 00:14:08.720
caching and various parameters and then you just click Create.

184
00:14:08.810 --> 00:14:16.210
So we now have two origins and we have a path pattern to direct some of the traffic there.

185
00:14:16.320 --> 00:14:22.500
You then go options around error pages geo restrictions so for instance you can enable geo restrictions

186
00:14:23.100 --> 00:14:25.740
and then you can choose to white list or blacklist.

187
00:14:25.740 --> 00:14:31.110
So if you wait list then you basically say well you know I'm in Australia so I want to make sure that

188
00:14:31.350 --> 00:14:35.230
I can access this bucket or I can access this cloud for distribution.

189
00:14:35.490 --> 00:14:42.030
So if I choose to whitelist Australia that means people who are located in Australia can access this

190
00:14:42.030 --> 00:14:46.520
CloudFront distribution or the content within this CloudFront distribution.

191
00:14:46.950 --> 00:14:51.570
If I choose blacklist it now means that everyone except Australia can.

192
00:14:51.600 --> 00:14:54.900
So you're now choosing the countries you don't want to be able to access it.

193
00:14:54.930 --> 00:15:00.110
So those are a couple of ways you can restrict access to your content based on the location of users.

194
00:15:00.120 --> 00:15:03.930
Another thing you can do with your content is invalidate your content.

195
00:15:03.930 --> 00:15:10.740
So what you do is you create an invalidation and then you can provide a path to your objects that you

196
00:15:10.740 --> 00:15:12.000
want to invalidate.

197
00:15:12.000 --> 00:15:16.050
You get charged extra for this and it can take a little bit of time to do it.

198
00:15:16.080 --> 00:15:21.300
But what it means is if your if for some reason you need to take something out of the cache because

199
00:15:21.300 --> 00:15:28.320
you've updated it and you really need to get the updated objects out you might have to come in and invalidate

200
00:15:28.320 --> 00:15:29.360
your objects.

201
00:15:29.370 --> 00:15:37.650
So the other thing I've done to make my lab work is I've gone into Route 53 and within my hosted

202
00:15:37.650 --> 00:15:46.020
zone for dctlabs.com I've created a record and that's an alias record that points to the cloud

203
00:15:46.020 --> 00:15:47.400
front distribution.

204
00:15:47.430 --> 00:15:53.440
So what you'd find is if you just go into alias targets you should see your S3 Website endpoint.

205
00:15:53.580 --> 00:15:57.610
But what we actually want to connect to is dctlabscom.

206
00:15:57.720 --> 00:16:05.300
So I've already created that record which means we should now be able to connect to dctlabscom

207
00:16:06.550 --> 00:16:10.560
and it's the same message that I've also got some of those image files.

208
00:16:10.570 --> 00:16:18.300
So I've got for instance CloudFront.JPEG and that just brings up a JPEG image.

209
00:16:18.300 --> 00:16:26.050
And I've got S3.jpg and another image so that all works great.

210
00:16:26.050 --> 00:16:33.880
Now let's go back to our S3 bucket and what I want to do here is I just want to take the path to

211
00:16:33.910 --> 00:16:42.510
my index file and I'm going to put that into my browser and I get an access denied message.

212
00:16:42.740 --> 00:16:44.210
And that's exactly what I expected.

213
00:16:44.240 --> 00:16:49.680
So if I go back to the bucket permissions bucket policy.

214
00:16:49.820 --> 00:16:57.470
This is the policy that was created by CloudFront and you can see we have a principle and the principle

215
00:16:57.530 --> 00:17:05.120
is specified as CloudFront user CloudFront origin access identity and then it's got some code and that

216
00:17:05.120 --> 00:17:13.350
user is allowed to get objects in dctlabs.com slash the if we just head up and go to our other

217
00:17:14.490 --> 00:17:19.440
folder that we created earlier and go to bucket policy hey you can see we've got the same thing and

218
00:17:19.440 --> 00:17:26.000
that's because we enable that option for CloudFront to automatically update our bucket policy.

219
00:17:26.010 --> 00:17:30.510
One thing to bear in mind is that if you already have a bucket policy for instance if you have a bucket

220
00:17:30.510 --> 00:17:39.250
policy that allows public access what will happen is the CloudFront policy will be added as another

221
00:17:39.820 --> 00:17:40.440
aside.

222
00:17:40.480 --> 00:17:45.370
So you'll have already two with the CloudFront policy and you'll still have your original bucket policy

223
00:17:45.370 --> 00:17:45.670
in there.

224
00:17:45.670 --> 00:17:50.470
So anonymous access will still be allowed and if that's the case you might have to come in and sort

225
00:17:50.470 --> 00:17:53.170
of you know delete out the bits that you don't need.

226
00:17:53.170 --> 00:17:54.700
So that's really it for now.

227
00:17:54.850 --> 00:17:59.860
What we've done is we've created a three bucket configured as a static Web site.

228
00:17:59.950 --> 00:18:06.100
We've collected a CloudFront distribution and that CloudFront distribution has been configured with

229
00:18:06.160 --> 00:18:12.160
Origin access identity and it's been also configured to automatically update a bucket policy such that

230
00:18:12.880 --> 00:18:17.180
only CloudFront can now talk to your S3 bucket and access the content.

231
00:18:17.830 --> 00:18:20.310
So that's very simple that's how it all works.

232
00:18:20.320 --> 00:18:24.880
Now what we need to do just to clean up this lab because we'll be creating some new distributions in

233
00:18:24.880 --> 00:18:27.320
the next lab we can come back.

234
00:18:27.960 --> 00:18:31.080
Obviously you can go in and delete your buckets you know how to do that.

235
00:18:31.390 --> 00:18:43.980
And then from CloudFrons we just need to go in and we have to disable our distributions so go in and

236
00:18:43.980 --> 00:18:44.730
click disable

237
00:18:47.500 --> 00:18:51.540
and you'll notice that we had an in progress there and that's just because we've made a couple of changes.

238
00:18:51.550 --> 00:18:57.040
So any changes you might you'll see that it takes a while to actually you know put those changes fully

239
00:18:57.040 --> 00:19:01.060
out into the world into the various points of presence.

240
00:19:01.110 --> 00:19:07.030
So you click on disable and you've got to wait until these full are fully disabled and then you'll be

241
00:19:07.030 --> 00:19:08.800
able to delete your distributions.

242
00:19:08.800 --> 00:19:15.790
So don't forget to come back because it might take 15 minutes or so for these to complete and at that

243
00:19:15.790 --> 00:19:18.040
point you can then go and delete your distribution.

