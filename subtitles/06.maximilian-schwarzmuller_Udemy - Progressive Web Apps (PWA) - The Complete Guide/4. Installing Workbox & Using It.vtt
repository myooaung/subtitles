WEBVTT

00:02.020 --> 00:08.140
I'm back in our project folder and there first of all, I want to install workbox.

00:08.140 --> 00:14.410
Now as I mentioned, you can implement it in your workbox workflow or in your workflow or whatever

00:14.410 --> 00:14.960
you have

00:15.010 --> 00:20.830
and of course I'll come back to that too and guide you into the right direction to do just that

00:21.100 --> 00:27.700
but you can also just use the CLI and use it in your project just with npm scripts and this is the approach

00:27.730 --> 00:33.820
I want to use here for the same reason I chose this project set up in this course in general. I want

00:33.820 --> 00:39.490
to show you a very generic approach which works in all your project instead of focusing on one which

00:39.640 --> 00:42.280
then is hard to apply to other project setups.

00:42.280 --> 00:46.000
So for that, let's open up the terminal, this is just the normal Mac terminal

00:46.000 --> 00:50.170
integrated into my IDE again, navigate it into this project folder.

00:50.260 --> 00:53.250
Now with npm, I'll only install a new package and

00:53.250 --> 00:59.630
I'll add the --save-dev flag to save it as a development dependency entry in my package.json

00:59.650 --> 01:04.730
file. The name of the package is workbox-cli,

01:04.780 --> 01:09.880
this is the CLI of the workbox tool and you can use that in any project.

01:09.880 --> 01:14.050
Now let me hit enter here and this will install that CLI,

01:14.050 --> 01:16.860
now of course I'll also show you how to use it.

01:17.110 --> 01:20.050
So let's quickly wait for this installation to finish

01:20.810 --> 01:23.050
and let's now use that tool.

01:23.060 --> 01:27.850
Now if we have a look at that package.json file, we see the workbox CLI was installed here

01:28.430 --> 01:34.550
and we can now actually write a little script here to use it. I'll write a script and I'll simply name

01:34.550 --> 01:42.230
it generate-sw because I want to automatically generate a service worker with this tool and for that,

01:42.290 --> 01:44.060
I will execute workbox.

01:44.240 --> 01:53.150
The package is called workbox CLI but it actually exposes a command named workbox and there, we now

01:53.150 --> 01:59.380
can run generate:sw. Now this is the command 

01:59.390 --> 02:06.490
I want to execute and we can now run this by running npm run and execute our own script, generate-sw, so

02:06.490 --> 02:09.230
now we execute this script here.

02:09.670 --> 02:16.770
If we now hit enter, we get a prompt and there the first question is what our root of the web app is.

02:16.870 --> 02:21.310
So for us, that's a public folder because that is from where this application get served,

02:21.490 --> 02:28.480
let's hit enter here. Then you can define which kind of files you want to precache.

02:28.660 --> 02:31.090
Now here, I'll leave all enabled,

02:31.090 --> 02:33.370
we'll later tweak this,

02:33.470 --> 02:39.560
the next question is where the new service worker should be stored and here, I'll overwrite the default because

02:39.560 --> 02:41.510
I want to store it in public/

02:41.750 --> 02:47.060
and now sw.js because I don't want to overwrite my existing one yet.

02:47.150 --> 02:52.510
So don't use sw.js, don't overwrite this existing file, pick a different file

02:52.520 --> 02:54.470
but in the same folder.

02:54.470 --> 02:57.310
So here, I'll hit enter and in the last question,

02:57.310 --> 02:59.810
do we want to save the settings in a config file?

02:59.900 --> 03:00.970
Definitely hit yes

03:01.010 --> 03:02.050
here, so y

03:02.120 --> 03:03.380
and hit enter.

03:03.470 --> 03:06.810
Now this gives you a new file, the workbox-cli.config.js

03:06.870 --> 03:07.370
and

03:07.580 --> 03:10.980
it gives you two new files in the public folder, this

03:11.150 --> 03:14.970
workbox-sw.prod file and this service-worker.js

03:14.970 --> 03:21.840
file. If you open the service-worker.js file, this is the file automatically generated by

03:21.840 --> 03:22.800
that CLI.

03:23.330 --> 03:25.150
Now in that file, you'll notice

03:25.160 --> 03:27.410
you have this file manifest array

03:27.590 --> 03:33.500
and here you see a lot of the files of your project being referenced together with a unique hash number

03:33.620 --> 03:35.100
or hash ID.

03:35.200 --> 03:41.500
This ID is used by workbox to automatically manage your versions, your file versions

03:41.570 --> 03:48.500
and if you change one of these files and rerun the generate-sw command, it will update the hash ID

03:48.590 --> 03:51.620
of any file you changed in this array.

03:51.620 --> 03:58.490
This becomes important because it uses this revision ID to manage your cache and invalidate replace

03:58.610 --> 04:00.220
outdated resources,

04:00.320 --> 04:06.800
what we had to do previously manually with our static cache version number we had to bump up, here it's managed

04:06.800 --> 04:11.150
on a per asset basis automatically for us which is pretty awesome.

04:11.480 --> 04:14.930
So here, it actually caches everything, we're going to adjust this later

04:15.110 --> 04:20.660
and then you see at the bottom, it creates a new instance of this, basically of the workbox package

04:20.660 --> 04:26.950
I can say we just installed and then call the precache command to simply precache all these files

04:27.410 --> 04:33.260
and behind the scenes, this will do a lot more. This will actually put all these files into the cache during

04:33.260 --> 04:34.490
the install step,

04:34.490 --> 04:39.940
so basically what we did manually here at the top of our sw.js file,

04:40.070 --> 04:43.560
we also stored some static files during installation.

04:43.580 --> 04:49.550
Now this happens automatically and it also sets up a fetch listener to listen for any of these files

04:49.550 --> 04:54.320
being requested and then serving it from the cache even when offline.

04:54.320 --> 05:00.890
Now what this does is that when we switch to this new service worker by going to source javascript

05:00.970 --> 05:11.600
app.js, let's register service worker here instead of sw.js. If we do this, let's make sure npm

05:11.600 --> 05:15.620
start is running so that our development server is running.

05:15.620 --> 05:22.640
Now if we navigate to our application, let's clear the storage to get rid of the old service worker and

05:22.640 --> 05:24.800
then reload this page.

05:24.800 --> 05:27.730
Now what you'll see is it should still work

05:27.950 --> 05:33.800
but if you go to the application tab and refresh your cache storage, you'll see there actually is now

05:33.850 --> 05:41.450
this workbox precaching revision thing and that actually caches or holds all the items which were part

05:41.450 --> 05:46.880
of this file manifest array. All the other caches are gone because our own service worker is not getting

05:46.880 --> 05:47.430
used,

05:47.450 --> 05:50.420
therefore for now we lost many features but no worries,

05:50.420 --> 05:51.890
we're going to re-introduce them

05:52.160 --> 05:57.560
but you'll see that if I go offline, whilst the styles and so are missing because we're not caching

05:57.560 --> 06:00.140
them right now, again this will be added,

06:00.200 --> 06:06.400
generally it does work offline, it precached our file here.

06:06.530 --> 06:13.340
It can't open the menu because it didn't cache some other important files but in general, it is working.

06:13.460 --> 06:17.620
Now of course, it's not really that great and we definitely need to enhance this,

06:17.630 --> 06:21.590
we need to make sure we also cache the styling and the fonts and so on

06:21.860 --> 06:27.920
but we are using this new service worker already and you can see, it seems to serve something if we're

06:27.920 --> 06:28.710
offline,

06:28.730 --> 06:36.050
so clearly this precache function does a lot of work for us. Now that's the basic set up, of course right

06:36.050 --> 06:39.130
now we kind of made our project way worse,

06:39.230 --> 06:45.050
we're going to fix this soon though and in a brand new project, this might be a good way to start because

06:45.050 --> 06:50.540
you immediately precached your static assets and if you don't need more than that, you're already done.

06:50.540 --> 06:53.200
We're not done yet though so let's continue

06:53.210 --> 06:54.440
and enhance this set up.
